import yagmail
import csv
from time import sleep

class MailSender():

    _company = 'BIP Bank'
    _sender = 'bipbank2022@gmail.com'
    _phishing_url = 'https://youtu.be/ZviCeIfBrE4'  # dummy

    def writeCSV(self, victims_dict):
        with open('victims.csv', 'a', newline='') as csvfile:
            writer = csv.writer(csvfile)
            for email in victims_dict.keys():
                writer.writerow([email, victims_dict[email]])


    def sendMails(self):
        gmail_context = yagmail.SMTP(self._sender)

        with open('victims.csv', 'r', newline='') as csvfile:
            reader = csv.reader(csvfile)
            [self._send(gmail_context, victim_record[0], self.__prepareMail(victim_record[1])) for victim_record in reader]


    def __prepareMail(self, name):
        hello_part = f'Здравствуйте, {name}'
        html = f"""\
                    <body>
                        <p><b>Подозрительная активность</b><br>
                        {hello_part}! Cлужба информационной безопасности {self._company} выявила подозрительную активность в вашем аккаунте. В данный \
                        момент Ваши счета могут находятся в руках злоумышленников.<br>
                        Для предотвращения активности необходимо:
                        <ol>
                            <li>Войти в <a href="{self._phishing_url}">Личный Кабинет</a></li>
                            <li>Следовать инструкции из пункта \"Безопасность\"</li>
                        </ol>
                        Просим незамедлительно войти в личный кабинет и выполнить необходимые действия. В противном случае Ваши \
                        счета будут заморожены через 30 \
                        минут на время проведения проверки правоохранительными органами (до 30 суток).
                        <br>
                        <b>Служба безопасности {self._company}</b>
                        </p>
                    </body>
                """
        return html


    def _send(self, yag, receiver, mail):
            yag.send(
                to=receiver,
                subject="Подозрительная активность",
                contents=mail,
            )
            sleep(0.5)


if __name__ == '__main__':
    sender = MailSender()
    sender.sendMails()


